---
title: "Mixed Tests - Two Group Design" 
author: "Goknur Giner"
date: "March 02 2017"
output:
  pdf_document: default
  html_notebook: default
  number_sections: yes
  html_document: default
  toc: yes
  toc_depth: 2
---
## Design Basic (Two group design)
This expreiment is designed to have 3 replicates in both conditions.
DE and Non-DE set indices are stored in the variable called 'Truth'.
Every set has %40 up and %40 down genes.
Gene set tests FRY with different standardization arguments and ROAST with 1000 
rotations are run and the resulting tables are saved in corresponding variables.
False and True discovery rates are computed by counting the number of DE sets 
which is correctly identified based on the 'Truth' vector.
```{r default_parameters, warning=FALSE, echo=TRUE, prompt=TRUE, comment=NA, message=FALSE, size="footnotesize"}
library(limma)
ngenes <- 1e+05  # number of genes
nsamples <- 6  # number of samples  
prop.set <- 0.1  # proportion of DE sets
setsize <- c(4, 12, 20, 40, 80, 160)  # number of genes in each set
lfc <- c(1.1, 1.2, 1.3, 1.4)  # log fold changes
rho <- c(0, 0.1)  # correlation coefficient
s0 <- 0.3
d0 <- 4
sigma2 <- s0^2 * d0/rchisq(ngenes, df = d0)
for (s in setsize) {
    print(paste0("set size is ", s))
    for (l in lfc) {
        print(paste0("logFC is ", s))
        for (r in rho) {
            print(paste0("correlation is ", s))
            y <- matrix(rnorm(ngenes * nsamples), ngenes, nsamples)
            y <- y * sqrt(sigma2)
            # Add correlation
            #e <- matrix(rnorm(nsamples), ngenes, nsamples, byrow = TRUE)
            #y <- sqrt(r) * e + sqrt(1 - r) * y
            design <- cbind(1, c(0, 0, 0, 1, 1, 1))
            nsets <- ngenes/s  # number of sets
            nDESets <- nsets * prop.set  # number of DE sets
            Truth <- rep(0, nsets)
            Truth[sample(nsets, nDESets)] <- 1
            index <- list()
            i <- 1:s
            for (j in 1:nsets) {
                index[[j]] <- i
                if (Truth[j]) {
                  y[i[1]:i[ceiling(s * 0.4)], 4:6] <- 
                    y[i[1]:i[ceiling(s * 0.4)], 4:6] + log2(l)
                  y[i[ceiling(s * 0.4) + 1]:i[ceiling(s * 0.8)], 4:6] <- 
                    y[i[ceiling(s * 0.4) + 1]:i[ceiling(s * 0.8)], 4:6] - log2(l)
                }
                i <- i + s
            }
            f.n <- fry(y, index = index, design = design, standardize = "none", sort = "n")
            f.r <- fry(y, index = index, design = design, standardize = "r", sort = "n")
            f.p <- fry(y, index = index, design = design, standardize = "posterior", sort = "n")
            ro <- mroast(y, index = index, design = design, nrot = 999, sort = "n")
            o <- order(f.n$PValue.Mixed)
            NFD.n <- cumsum(1 - Truth[o])
            NTD.n <- cumsum(Truth[o])
            o <- order(f.r$PValue.Mixed)
            NFD.r <- cumsum(1 - Truth[o])
            NTD.r <- cumsum(Truth[o])
            o <- order(f.p$PValue.Mixed)
            NFD.p <- cumsum(1 - Truth[o])
            NTD.p <- cumsum(Truth[o])
            o <- order(ro$PValue.Mixed)
            NFD.ro <- cumsum(1 - Truth[o])
            NTD.ro <- cumsum(Truth[o])
            n <- ceiling(nDESets)
            m <- max(NFD.n[n], NFD.r[n], NFD.p[n])
            plot(1:n, seq(0, m, len = n), type = "n", xlab = "Number selected", 
              ylab = "Number of false discoveries", 
              main = paste0("False Discovery Rate (Set size = ", s, ", logFC = ", l, ")"))
            lines(NFD.n[1:n], col = "black")  # only plot up to number of DE gene sets
            lines(NFD.r[1:n], col = "blue")
            lines(NFD.p[1:n], col = "red")
            lines(NFD.ro[1:n], col = "black", lty = 2)
            legend("topleft", lty = c(1, 1, 1, 2), col = c("black", "blue", "red", "black"), 
              legend = c("fry-n", "fry-r", "fry-p", "roast"))
            head(t <- cbind(f.n[o, ], T = Truth[o]))
            # head(t <- t[t$T==1,])
            table(t$T, t$PValue.Mixed <= 0.05)
            # table(NFD.n[1:n])
            sum(Truth[o][1:n] == 0)  # number of false discoveries among DE gene sets
            TPR.n <- NTD.n/n
            FPR.n <- NFD.n/n
            TPR.p <- NTD.p/n
            FPR.p <- NFD.p/n
            TPR.r <- NTD.r/n
            FPR.r <- NFD.r/n
            TPR.ro <- NTD.ro/n
            FPR.ro <- NFD.ro/n
            x <- max(FPR.n[n], FPR.r[n], FPR.p[n], FPR.ro[n])
            y <- max(TPR.n[n], TPR.r[n], TPR.p[n], TPR.ro[n])
            plot(c(0, x), c(0, y), type = "n", xlab = "False Positive Rate", 
              ylab = "True Positive Rate", 
              main = paste0("TDR vs FDR (Set size = ", s, ", logFC = ", l, ")"))
            lines(FPR.n[1:n], TPR.n[1:n], col = "black")
            lines(FPR.r[1:n], TPR.r[1:n], col = "blue")
            lines(FPR.p[1:n], TPR.p[1:n], col = "red")
            lines(FPR.ro[1:n], TPR.ro[1:n], col = "black", lty = 2)
            legend("bottomright", lty = c(1, 1, 1, 2), col = c("black", "blue", "red", "black"), 
              legend = c("fry-n", "fry-r", "fry-p", "roast"))
        }
    }
}
```
